---
title: "Project"
output:
  html_document:
    df_print: paged
  pdf_document: default
  fig_width: 4
  fig_height: 3
---
```{r setup, include=FALSE}
set.seed(7406)

setwd("./")

library(tidyverse)
library(dplyr)
library(ggplot2)
library(readxl)

knitr::opts_chunk$set(echo = TRUE,fig.align='center') 
```

# Introduction
Introduction - What are you trying to do? Where does the data come from? Sometimes I break this into a two sections - Problem Description and Data Set

```{r load data}
#load spreadsheet (takes several minutes)
#data_orig = read_excel("complaints-2024-02-12_19_15.xlsx")
data_orig = read.csv("complaints-2024-03-04_20_55.csv")
```

# Exploratory Data Analysis
Size of dataset, variable descriptions, distribution of data, heat maps, correlation plots. This section was heavy on visuals.

```{r explore data}
data = data_orig   #so we don't have to keep loading it if we need to restart

#summarize data
head(data)
summary(data) 
dim(data)
colSums(is.na(data))  #num of blank columns

#clean data for exploration
data$date_received <- as.Date(data$'Date.received',format = "%m/%d/%y")
data$date_received_year <- format(as.Date(data$date_received, 
                                          format="%m/%d/%y"),"%Y")
data$date_sent_to_company <- as.Date(data$'Date.sent.to.company',format = "%m/%d/%y")
data$date_sent_to_company_year <- format(as.Date(data$date_sent_to_company,
                                                 format="%m/%d/%y"),"%Y")
data <- data %>% rename_at('Sub.product', ~'Sub_product')
data <- data %>% rename_at('Sub.issue', ~'Sub_issue')
data <- data %>% rename_at('ZIP.code', ~'zip')
data <- data %>% rename_at('Consumer.consent.provided.', ~'consent')
data <- data %>% rename_at('Company.response.to.consumer', ~'response_sent')
data <- data %>% rename_at('Timely.response.', ~'response_timely')
data <- data %>% rename_at('Consumer.disputed.', ~'response_disputed')

#zip codes with XX in data - 230,158
data %>%
    filter(str_detect(zip, "XX")) %>%
    summarise(n = n())

#some zip codes do not have clean data
#add a column to just get data with
data_clean_zip <- data %>%
    filter(str_detect(zip, "^[:digit:]+$")) 

#save plottable data into new variable
dataplot <- data %>% select(-one_of('Consumer.complaint.narrative',
                                    'Company.public.response',
                                    'Complaint.ID',
                                    'Submitted.via',
                                    'Date.received',
                                    'Date.sent.to.company'))
```

Roll up data by category summary counts

```{r summarize data}
data_clean_zip %>%
    # 1,788,973 vs 2,036,509 clean zip codes (88% clean)
    group_by(substr(zip,1,3)) %>%
    summarise(n = n()) %>%
    arrange(desc(n))

data_summarized <- data_clean_zip %>%
    group_by(Product,
             Issue,
             State,
             date_received_year) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
data_summarized

write.csv(data_summarized, "cfpb_data_summarized.csv", row.names=FALSE)
```

plot data
```{r plot data}
cols1 <- c("date_received","Issue")
issue_summary <- dataplot %>%
    group_by(across(all_of(cols1))) %>% 
    filter(Issue %in% c("Improper use of your report", 
                        "Incorrect information on your report", 
                        "Problem with a credit reporting company's investigation into an existing problem")) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
issue_summary
plot1 <- issue_summary %>%
    ggplot(aes(x=date_received, 
               y=n, 
               fill=Issue)) +
    geom_area()
plot1

cols2 <- c("date_received","Company")
company_summary <- dataplot %>%
    group_by(across(all_of(cols2))) %>% 
    filter(Company %in% c("EQUIFAX, INC.", 
                          "TRANSUNION INTERMEDIATE HOLDINGS, INC.", 
                          "Experian Information Solutions Inc.")) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
company_summary
plot2 <- company_summary %>%
    ggplot(aes(x=date_received, 
               y=n, 
               fill=Company)) +
    geom_area()
plot2

cols3 <- c("date_received","State")
state_summary <- dataplot %>%
    group_by(across(all_of(cols3))) %>% 
    filter(State %in% c("FL", 
                        "TX", 
                        "CA",
                        "GA",
                        "NY",
                        "IL")) %>%
    summarise(n = n()) %>%
    arrange(desc(n))
state_summary
plot3 <- state_summary %>%
    ggplot(aes(x=date_received, 
               y=n, 
               group=State, 
               color=State)) +
    geom_line(linewidth = 0.2)
plot3 + stat_smooth(aes(group=State),
                    method = "loess", 
                    size = 1)

cols4 <- c("date_received","response_sent")
response_summary <- dataplot %>%
    group_by(across(all_of(cols4))) %>% 
    summarise(n = n()) %>%
    arrange(desc(n))
response_summary
plot4 <- response_summary %>%
    ggplot(aes(x=date_received, 
               y=n, 
               group=response_sent, 
               color=response_sent)) +
    geom_line(linewidth = 0.2)
plot4 + stat_smooth(aes(group=response_sent),
                    method = "loess", 
                    size = 1)

```
